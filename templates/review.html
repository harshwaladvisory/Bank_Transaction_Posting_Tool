{% extends "base.html" %}
{% block title %}Review Transactions{% endblock %}
{% block content %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card bg-success text-white">
            <div class="stat-value">{{ by_module.CR|length }}</div>
            <div>Cash Receipts</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-danger text-white">
            <div class="stat-value">{{ by_module.CD|length }}</div>
            <div>Cash Disbursements</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-warning">
            <div class="stat-value">{{ by_module.JV|length }}</div>
            <div>Journal Vouchers</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-secondary text-white">
            <div class="stat-value">{{ by_module.UNKNOWN|length }}</div>
            <div>Unidentified</div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5><i class="bi bi-list-check"></i> Review Transactions</h5>
        <form action="/process" method="post">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-gear"></i> Generate Output Files
            </button>
        </form>
    </div>
    <div class="card-body">
        <!-- Quick Actions Bar -->
        <div class="row mb-3 align-items-center">
            <div class="col-md-8">
                <span id="filterCount" class="badge bg-info me-2"></span>
                <span id="activeFilterBadge" class="badge bg-primary d-none" style="font-size: 0.9em;">
                    Filtering: <span id="activeFilterText"></span>
                    <i class="bi bi-x-circle ms-1" style="cursor: pointer;" onclick="clearConfidenceFilter()"></i>
                </span>
            </div>
            <div class="col-md-4 text-end">
                <button type="button" class="btn btn-outline-warning btn-sm" id="editLowConfidence" title="Bulk edit all low confidence transactions">
                    <i class="bi bi-pencil-square"></i> Bulk Edit Low Confidence
                </button>
            </div>
        </div>

        <ul class="nav nav-tabs" id="moduleTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">All ({{ transactions|length }})</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cr-tab" data-bs-toggle="tab" data-bs-target="#cr" type="button" role="tab">CR ({{ by_module.CR|length }})</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cd-tab" data-bs-toggle="tab" data-bs-target="#cd" type="button" role="tab">CD ({{ by_module.CD|length }})</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="jv-tab" data-bs-toggle="tab" data-bs-target="#jv" type="button" role="tab">JV ({{ by_module.JV|length }})</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="unknown-tab" data-bs-toggle="tab" data-bs-target="#unknown" type="button" role="tab">Unknown ({{ by_module.UNKNOWN|length }})</button>
            </li>
        </ul>
        
        <div class="tab-content mt-3">
            <!-- ALL Tab -->
            <div class="tab-pane fade show active" id="all" role="tabpanel">
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Module</th>
                            <th>GL Code</th>
                            <th class="confidence-header">
                                <div class="dropdown d-inline">
                                    <span class="dropdown-toggle" style="cursor: pointer;" data-bs-toggle="dropdown" aria-expanded="false" title="Click to filter by confidence">
                                        <i class="bi bi-funnel-fill me-1"></i>Confidence
                                    </span>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item confidence-filter-item" href="#" data-filter="all"><i class="bi bi-list"></i> All Levels</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item confidence-filter-item" href="#" data-filter="high"><span class="badge bg-success me-2">●</span> High Confidence</a></li>
                                        <li><a class="dropdown-item confidence-filter-item" href="#" data-filter="medium"><span class="badge bg-warning me-2">●</span> Medium Confidence</a></li>
                                        <li><a class="dropdown-item confidence-filter-item" href="#" data-filter="low"><span class="badge bg-danger me-2">●</span> Low Confidence</a></li>
                                        <li><a class="dropdown-item confidence-filter-item" href="#" data-filter="none"><span class="badge bg-secondary me-2">●</span> No Match</a></li>
                                    </ul>
                                </div>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for txn in transactions %}
                        <tr class="txn-row {{ 'needs-review' if txn.confidence_level in ['low', 'none'] }}" data-confidence="{{ txn.confidence_level }}" data-index="{{ loop.index0 }}">
                            <td>{{ txn.date }}</td>
                            <td title="{{ txn.description }}">{{ txn.description[:40] }}{% if txn.description|length > 40 %}...{% endif %}</td>
                            <td class="{{ 'text-success' if txn.amount > 0 else 'text-danger' }}">
                                ${{ '{:,.2f}'.format(txn.amount|abs) }}
                            </td>
                            <td><span class="badge bg-{{ 'success' if txn.module == 'CR' else 'danger' if txn.module == 'CD' else 'warning' if txn.module == 'JV' else 'secondary' }}">{{ txn.module }}</span></td>
                            <td class="gl-code">{{ txn.gl_code or '-' }}</td>
                            <td class="confidence-{{ txn.confidence_level }} confidence-cell" style="cursor: pointer;" onclick="filterByConfidence('{{ txn.confidence_level }}')" title="Click to filter by {{ txn.confidence_level }}"><span class="badge bg-{{ 'success' if txn.confidence_level == 'high' else 'warning' if txn.confidence_level == 'medium' else 'danger' if txn.confidence_level == 'low' else 'secondary' }}">{{ txn.confidence_level }}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary edit-btn" data-index="{{ loop.index0 }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- CR Tab -->
            <div class="tab-pane fade" id="cr" role="tabpanel">
                {% if by_module.CR %}
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>GL Code</th>
                            <th>Confidence</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for txn in by_module.CR %}
                        <tr>
                            <td>{{ txn.date }}</td>
                            <td title="{{ txn.description }}">{{ txn.description[:40] }}{% if txn.description|length > 40 %}...{% endif %}</td>
                            <td class="text-success">${{ '{:,.2f}'.format(txn.amount|abs) }}</td>
                            <td>{{ txn.gl_code or '-' }}</td>
                            <td class="confidence-{{ txn.confidence_level }} confidence-cell" style="cursor: pointer;" onclick="filterByConfidence('{{ txn.confidence_level }}')" title="Click to filter by {{ txn.confidence_level }}"><span class="badge bg-{{ 'success' if txn.confidence_level == 'high' else 'warning' if txn.confidence_level == 'medium' else 'danger' if txn.confidence_level == 'low' else 'secondary' }}">{{ txn.confidence_level }}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary edit-btn" data-index="{{ loop.index0 }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="alert alert-info">No Cash Receipt transactions</div>
                {% endif %}
            </div>
            
            <!-- CD Tab -->
            <div class="tab-pane fade" id="cd" role="tabpanel">
                {% if by_module.CD %}
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>GL Code</th>
                            <th>Confidence</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for txn in by_module.CD %}
                        <tr>
                            <td>{{ txn.date }}</td>
                            <td title="{{ txn.description }}">{{ txn.description[:40] }}{% if txn.description|length > 40 %}...{% endif %}</td>
                            <td class="text-danger">${{ '{:,.2f}'.format(txn.amount|abs) }}</td>
                            <td>{{ txn.gl_code or '-' }}</td>
                            <td class="confidence-{{ txn.confidence_level }} confidence-cell" style="cursor: pointer;" onclick="filterByConfidence('{{ txn.confidence_level }}')" title="Click to filter by {{ txn.confidence_level }}"><span class="badge bg-{{ 'success' if txn.confidence_level == 'high' else 'warning' if txn.confidence_level == 'medium' else 'danger' if txn.confidence_level == 'low' else 'secondary' }}">{{ txn.confidence_level }}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary edit-btn" data-index="{{ loop.index0 }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="alert alert-info">No Cash Disbursement transactions</div>
                {% endif %}
            </div>
            
            <!-- JV Tab -->
            <div class="tab-pane fade" id="jv" role="tabpanel">
                {% if by_module.JV %}
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>GL Code</th>
                            <th>Confidence</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for txn in by_module.JV %}
                        <tr>
                            <td>{{ txn.date }}</td>
                            <td title="{{ txn.description }}">{{ txn.description[:40] }}{% if txn.description|length > 40 %}...{% endif %}</td>
                            <td>${{ '{:,.2f}'.format(txn.amount|abs) }}</td>
                            <td>{{ txn.gl_code or '-' }}</td>
                            <td class="confidence-{{ txn.confidence_level }} confidence-cell" style="cursor: pointer;" onclick="filterByConfidence('{{ txn.confidence_level }}')" title="Click to filter by {{ txn.confidence_level }}"><span class="badge bg-{{ 'success' if txn.confidence_level == 'high' else 'warning' if txn.confidence_level == 'medium' else 'danger' if txn.confidence_level == 'low' else 'secondary' }}">{{ txn.confidence_level }}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary edit-btn" data-index="{{ loop.index0 }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="alert alert-info">No Journal Voucher transactions</div>
                {% endif %}
            </div>
            
            <!-- Unknown Tab -->
            <div class="tab-pane fade" id="unknown" role="tabpanel">
                {% if by_module.UNKNOWN %}
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>GL Code</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for txn in by_module.UNKNOWN %}
                        <tr class="needs-review">
                            <td>{{ txn.date }}</td>
                            <td title="{{ txn.description }}">{{ txn.description[:40] }}{% if txn.description|length > 40 %}...{% endif %}</td>
                            <td>${{ '{:,.2f}'.format(txn.amount|abs) }}</td>
                            <td>{{ txn.gl_code or '-' }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary edit-btn" data-index="{{ loop.index0 }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="alert alert-success">All transactions classified!</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Balance Summary Card -->
<div class="card mt-4">
    <div class="card-header bg-dark text-white">
        <h5><i class="bi bi-calculator"></i> Bank Statement Summary</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Total Deposits (Money In)</h6>
                        <h3 class="text-success">${{ '{:,.2f}'.format(summary.total_credits) }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-danger">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Total Withdrawals (Money Out)</h6>
                        <h3 class="text-danger">${{ '{:,.2f}'.format(summary.total_debits) }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-{{ 'success' if summary.balance >= 0 else 'info' }}">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Net Cash Flow</h6>
                        <h3 class="{{ 'text-success' if summary.balance >= 0 else 'text-info' }}">
                            {% if summary.balance >= 0 %}
                            <i class="bi bi-arrow-up-circle text-success"></i> ${{ '{:,.2f}'.format(summary.balance) }}
                            {% else %}
                            <i class="bi bi-arrow-down-circle text-info"></i> -${{ '{:,.2f}'.format(summary.balance|abs) }}
                            {% endif %}
                        </h3>
                        {% if summary.balance >= 0 %}
                        <small class="text-success">Bank balance increased</small>
                        {% else %}
                        <small class="text-info">Bank balance decreased</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="alert alert-light mt-3 mb-0">
            <small><i class="bi bi-info-circle"></i> <strong>Note:</strong> This shows net cash flow from the bank statement. When journal entries are generated, each entry will be balanced (Dr = Cr).</small>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editIndex">
                    <div class="mb-3">
                        <label class="form-label">Module</label>
                        <select class="form-select" id="editModule">
                            <option value="CR">Cash Receipt (CR)</option>
                            <option value="CD">Cash Disbursement (CD)</option>
                            <option value="JV">Journal Voucher (JV)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">GL Code</label>
                        <input type="text" class="form-control" id="editGLCode">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fund Code</label>
                        <input type="text" class="form-control" id="editFundCode">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payee/Vendor</label>
                        <input type="text" class="form-control" id="editPayee">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEdit">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Edit Modal for Low Confidence -->
<div class="modal fade" id="bulkEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Bulk Edit Low Confidence Transactions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i> Edit GL codes for all low confidence transactions below. Changes will be applied when you click "Save All Changes".
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-bordered" id="bulkEditTable">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 100px;">Date</th>
                                <th>Description</th>
                                <th style="width: 100px;">Amount</th>
                                <th style="width: 100px;">Module</th>
                                <th style="width: 120px;">GL Code</th>
                                <th style="width: 100px;">Fund</th>
                            </tr>
                        </thead>
                        <tbody id="bulkEditBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="saveBulkEdit"><i class="bi bi-save"></i> Save All Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const editModal = new bootstrap.Modal(document.getElementById('editModal'));
const bulkEditModal = new bootstrap.Modal(document.getElementById('bulkEditModal'));

// Transaction data for JavaScript operations
const transactionsData = [
    {% for txn in transactions %}
    {
        index: {{ loop.index0 }},
        date: "{{ txn.date }}",
        description: "{{ txn.description | replace('"', '\\"') | replace('\n', ' ') }}",
        amount: {{ txn.amount }},
        module: "{{ txn.module }}",
        gl_code: "{{ txn.gl_code or '' }}",
        fund_code: "{{ txn.fund_code or '1000' }}",
        confidence_level: "{{ txn.confidence_level }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Confidence Filter Functionality
const filterCount = document.getElementById('filterCount');
const activeFilterBadge = document.getElementById('activeFilterBadge');
const activeFilterText = document.getElementById('activeFilterText');
let currentFilter = 'all';

// Filter labels for display
const filterLabels = {
    'all': 'All Levels',
    'high': 'High Confidence',
    'medium': 'Medium Confidence',
    'low': 'Low Confidence',
    'none': 'No Match'
};

// Apply filter by confidence level
function filterByConfidence(confidence) {
    currentFilter = confidence;
    const rows = document.querySelectorAll('.txn-row');
    let visibleCount = 0;
    let totalCount = rows.length;

    rows.forEach(row => {
        const rowConfidence = row.getAttribute('data-confidence');
        if (confidence === 'all' || rowConfidence === confidence) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Update filter badge and count
    if (confidence === 'all') {
        activeFilterBadge.classList.add('d-none');
        filterCount.textContent = `${totalCount} transactions`;
    } else {
        activeFilterBadge.classList.remove('d-none');
        activeFilterText.textContent = filterLabels[confidence] || confidence;
        filterCount.textContent = `Showing ${visibleCount} of ${totalCount}`;
    }
}

// Clear filter (show all)
function clearConfidenceFilter() {
    filterByConfidence('all');
}

// Handle dropdown filter clicks
document.querySelectorAll('.confidence-filter-item').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        const filter = this.getAttribute('data-filter');
        filterByConfidence(filter);
    });
});

// Single Edit Modal
document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const index = parseInt(this.dataset.index);
        const txn = transactionsData[index];

        document.getElementById('editIndex').value = index;
        document.getElementById('editModule').value = txn.module;
        document.getElementById('editGLCode').value = txn.gl_code;
        document.getElementById('editFundCode').value = txn.fund_code;
        document.getElementById('editPayee').value = '';

        editModal.show();
    });
});

document.getElementById('saveEdit').addEventListener('click', function() {
    const data = {
        index: parseInt(document.getElementById('editIndex').value),
        module: document.getElementById('editModule').value,
        gl_code: document.getElementById('editGLCode').value,
        fund_code: document.getElementById('editFundCode').value,
        payee: document.getElementById('editPayee').value
    };

    fetch('/update_transaction', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            location.reload();
        } else {
            alert(result.message);
        }
    });
});

// Bulk Edit Low Confidence Functionality
document.getElementById('editLowConfidence').addEventListener('click', function() {
    const lowConfidenceTxns = transactionsData.filter(t => t.confidence_level === 'low' || t.confidence_level === 'none');

    if (lowConfidenceTxns.length === 0) {
        alert('No low confidence transactions to edit!');
        return;
    }

    const tbody = document.getElementById('bulkEditBody');
    tbody.innerHTML = '';

    lowConfidenceTxns.forEach(txn => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${txn.date}</td>
            <td title="${txn.description}">${txn.description.substring(0, 30)}${txn.description.length > 30 ? '...' : ''}</td>
            <td class="${txn.amount > 0 ? 'text-success' : 'text-danger'}">$${Math.abs(txn.amount).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            <td>
                <select class="form-select form-select-sm bulk-module" data-index="${txn.index}">
                    <option value="CR" ${txn.module === 'CR' ? 'selected' : ''}>CR</option>
                    <option value="CD" ${txn.module === 'CD' ? 'selected' : ''}>CD</option>
                    <option value="JV" ${txn.module === 'JV' ? 'selected' : ''}>JV</option>
                </select>
            </td>
            <td><input type="text" class="form-control form-control-sm bulk-gl" data-index="${txn.index}" value="${txn.gl_code}" placeholder="GL Code"></td>
            <td><input type="text" class="form-control form-control-sm bulk-fund" data-index="${txn.index}" value="${txn.fund_code}" placeholder="Fund"></td>
        `;
        tbody.appendChild(row);
    });

    bulkEditModal.show();
});

// Save Bulk Edit Changes
document.getElementById('saveBulkEdit').addEventListener('click', async function() {
    const updates = [];

    document.querySelectorAll('#bulkEditBody tr').forEach(row => {
        const moduleSelect = row.querySelector('.bulk-module');
        const glInput = row.querySelector('.bulk-gl');
        const fundInput = row.querySelector('.bulk-fund');

        updates.push({
            index: parseInt(moduleSelect.dataset.index),
            module: moduleSelect.value,
            gl_code: glInput.value,
            fund_code: fundInput.value
        });
    });

    // Send bulk update to server
    try {
        const response = await fetch('/bulk_update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({updates: updates})
        });

        const result = await response.json();
        if (result.status === 'success') {
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('Error saving changes: ' + error.message);
    }
});

// Initialize filter count on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize transaction count
    filterCount.textContent = `${transactionsData.length} transactions`;

    // Count low confidence transactions
    const lowCount = transactionsData.filter(t => t.confidence_level === 'low' || t.confidence_level === 'none').length;
    if (lowCount > 0) {
        document.getElementById('editLowConfidence').innerHTML = `<i class="bi bi-pencil-square"></i> Bulk Edit Low Confidence (${lowCount})`;
    }
});
</script>
{% endblock %}